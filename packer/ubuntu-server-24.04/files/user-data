#cloud-config
autoinstall:
  version: 1
  refresh-installer:
    update: true
  network:
    network:
      version: 2
      ethernets:
        eth0:
          dhcp4: true
  apt:
    primary:
      - arches: ["default"]
        uri: "http://archive.ubuntu.com/ubuntu/"
  identity:
    hostname: "ubuntu-server-22-04"
    username: "vagrant"
    password: "$6$CG/3wG6U6vagDFjC$WjSNjZaL/CqK/8SwMO0ARqvY614BG2LceS9ZEGr6K9PQhIDnNmlZVEG6z2LmoDYK0XYtP7emnR5Pte4j7DUoA0"
  packages:
    - "ca-certificates"
    - "cloud-guest-utils"
    - "cloud-init"
    - "curl"
    - "e2fsprogs"
    - "iproute2"
    - "net-tools"
    - "nfs-common"
    - "nfs-kernel-server"
    - "openssh-server"
    - "python3"
    - "rsync"
    - "sudo"
  ssh:
    install-server: true
    authorized-keys: []
    allow-pw: true
  user-data:
    disable_root: false
  storage:
    config:
      - grub_device: true
        id: "disk-sda"
        path: "/dev/sda"
        ptable: "gpt"
        type: "disk"
        wipe: "superblock-recursive"
      - device: "disk-sda"
        flag: "bios_grub"
        id: "partition-0"
        number: 1
        size: 1048576
        type: "partition"
      - device: "disk-sda"
        id: "partition-1"
        number: 2
        size: -1
        type: "partition"
        wipe: "superblock"
      - fstype: "ext4"
        id: "format-0"
        type: "format"
        volume: "partition-1"
      - device: "format-0"
        id: "mount-0"
        path: /
        type: "mount"
  timezone: "America/Denver"
  updates: "all"
  early-commands:
    - "systemctl stop ssh.service"
  late-commands:
    - |
      curtin in-target --target=/target -- /bin/bash -c ' \
          echo "root:vagrant" | chpasswd; \
          rm -rf /root/.bash_logout; \
          mkdir -p /root/.ssh; \
          chmod 0700 /root/.ssh; \
          echo "ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA6NF8iallvQVp22WDkTkyrtvp9eWW6A8YVr+kz4TjGYe7gHzIw+niNltGEFHzD8+v1I2YJ6oXevct1YeS0o9HZyN1Q9qgCgzUFtdOKLv6IedplqoPkcmF0aYet2PkEDo3MlTBckFXPITAMzF8dJSIFo9D8HfdOV0IAdx4O7PtixWKn5y2hMNG0zQPyUecp4pzC6kivAIhyfHilFR61RGL+GPXQ2MWZWFYbAGjyiYJnAmCP3NOTd0jMZEnDkbUvxhMmBYSdETk1rRgm+R4LOzFUGaHqHDLKLX+FIPKcF96hrucXzcWyLbIbEgE98OHlnVYCzRdK8jlqm8tehUc9c9WhQ== vagrant insecure public key" > /root/.ssh/authorized_keys; \
          chmod 0600 /root/.ssh/authorized_keys; \
          chown -Rf root:root /root; \
          groupadd -g 1000 vagrant; \
          useradd -g 1000 -u 1000 -d /home/vagrant -s /bin/bash -m vagrant; \
          echo "vagrant:vagrant" | chpasswd; \
          rm -rf /home/vagrant/.bash_logout; \
          mkdir -p /home/vagrant/.ssh; \
          chmod 0700 /home/vagrant/.ssh; \
          echo "ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA6NF8iallvQVp22WDkTkyrtvp9eWW6A8YVr+kz4TjGYe7gHzIw+niNltGEFHzD8+v1I2YJ6oXevct1YeS0o9HZyN1Q9qgCgzUFtdOKLv6IedplqoPkcmF0aYet2PkEDo3MlTBckFXPITAMzF8dJSIFo9D8HfdOV0IAdx4O7PtixWKn5y2hMNG0zQPyUecp4pzC6kivAIhyfHilFR61RGL+GPXQ2MWZWFYbAGjyiYJnAmCP3NOTd0jMZEnDkbUvxhMmBYSdETk1rRgm+R4LOzFUGaHqHDLKLX+FIPKcF96hrucXzcWyLbIbEgE98OHlnVYCzRdK8jlqm8tehUc9c9WhQ== vagrant insecure public key" > /home/vagrant/.ssh/authorized_keys; \
          chmod 0600 /home/vagrant/.ssh/authorized_keys; \
          chown -Rf vagrant:vagrant /home/vagrant; \
          mkdir -p /etc/sudoers.d; \
          chmod 0755 /etc/sudoers.d; \
          echo "vagrant ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/vagrant; \
          chmod 0440 /etc/sudoers.d/vagrant; \
          chown -Rf root:root /etc/sudoers.d; \
          sed -ie "s/^[#\s]*UseDNS.*$/UseDNS no/g" /etc/ssh/sshd_config; \
          ssh-keygen -A; \
          systemctl enable ssh.service; \
          sed -ie "s/^GRUB_DEFAULT=.*/GRUB_DEFAULT=\"0\"/g" /etc/default/grub; \
          sed -ie "s/^GRUB_CMDLINE_LINUX=.*/GRUB_CMDLINE_LINUX=\"net.ifnames=0 biosdevname=0 systemd.unified_cgroup_hierarchy=1\"/g" /etc/default/grub; \
          sed -ie "s/^GRUB_CMDLINE_LINUX_DEFAULT=.*/GRUB_CMDLINE_LINUX_DEFAULT=\"net.ifnames=0 biosdevname=0 systemd.unified_cgroup_hierarchy=1\"/g" /etc/default/grub; \
          update-grub; \
          update-initramfs -c -k all; \
          mkdir -p /etc/ssh/sshd_config.d; \
          echo "PubkeyAcceptedKeyTypes +ssh-rsa" > /etc/ssh/sshd_config.d/10-PubkeyAcceptedKeyTypes-ssh-rsa.conf; \
          chmod 600 /etc/ssh/sshd_config.d/10-PubkeyAcceptedKeyTypes-ssh-rsa.conf; \
          mkdir -p /etc/ssh/ssh_config.d; \
          echo "Host *" >> /etc/ssh/ssh_config.d/10-PubkeyAcceptedKeyTypes-ssh-rsa.conf; \
          echo "    HostkeyAlgorithms +ssh-rsa" >> /etc/ssh/ssh_config.d/10-PubkeyAcceptedKeyTypes-ssh-rsa.conf; \
          echo "    PubkeyAcceptedKeyTypes +ssh-rsa" >> /etc/ssh/ssh_config.d/10-PubkeyAcceptedKeyTypes-ssh-rsa.conf; \
          chmod 644 /etc/ssh/ssh_config.d/10-PubkeyAcceptedKeyTypes-ssh-rsa.conf; \
          apt-get -y purge snapd; \
          systemctl disable apt-daily.service; \
          systemctl disable apt-daily.timer; \
          systemctl disable apt-daily-upgrade.service; \
          systemctl disable apt-daily-upgrade.timer; \
          exit 0 \
      '
