---
- hosts: all
  become: false
  gather_facts: false
  tasks:
    - name: add kubernetes-dashboard repository to helm
      kubernetes.core.helm_repository:
        name: kubernetes-dashboard
        repo_url: https://kubernetes.github.io/dashboard/

    - name: install kubernetes-dashboard via helm
      kubernetes.core.helm:
        chart_ref: kubernetes-dashboard/kubernetes-dashboard
        chart_version: 6.0.8
        create_namespace: true
        name: kubernetes-dashboard
        release_namespace: kubernetes-dashboard
        state: present
        update_repo_cache: true
        values:
          extraArgs:
            - --enable-skip-login
            - --token-ttl=86400
      delay: 10
      register: helm_install
      retries: 6
      until: helm_install is success

    - name: enable loadbalancer on kubernetes dashboard
      kubernetes.core.k8s:
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: kubernetes-dashboard
            namespace: kubernetes-dashboard
          spec:
            type: LoadBalancer

    - name: create admin-user token
      kubernetes.core.k8s:
        definition:
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: admin-user
            namespace: kubernetes-dashboard

    - name: create admin-user rbac
      kubernetes.core.k8s:
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: admin-user
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: cluster-admin
          subjects:
            - kind: ServiceAccount
              name: admin-user
              namespace: kubernetes-dashboard

    - name: get kubernetes dashboard info
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: kubernetes-dashboard
        namespace: kubernetes-dashboard
      register: kubernetes_dashboard_info

    - name: generate secure update key
      ansible.builtin.set_fact:
        dnskey_secret: "{{ 'vagrant' | password_hash(hashtype='sha256',salt='vagrant') | b64encode }}"

    - name: register dns record
      community.general.nsupdate:
        key_algorithm: "hmac-sha256"
        key_name: "dnskey"
        key_secret: "{{ dnskey_secret }}"
        record: dashboard
        server: 10.0.3.40
        value: "{{ (kubernetes_dashboard_info.resources[0].status.loadBalancer.ingress[0].ip | string) }}"
        zone: lab.test

    - name: output kubernetes dashboard info
      block:
        - name: set kubernetes dashboard url variable
          ansible.builtin.set_fact:
            kubernetes_dashboard_url: "{{ 'https://' + (kubernetes_dashboard_info.resources[0].status.loadBalancer.ingress[0].ip | string) }}"

        - name: create admin-user token
          ansible.builtin.shell: kubectl -n kubernetes-dashboard create token admin-user --duration=488h
          register: kubectl_create_token

        - name: set kubernetes dashboard token variable
          ansible.builtin.set_fact:
            kubernetes_dashboard_token: "{{ kubectl_create_token.stdout }}"

        - name: create kubernetes dashboard info file
          ansible.builtin.copy:
            content: |
              Dashboard URL: {{ kubernetes_dashboard_url }}
              Token: {{ kubernetes_dashboard_token }}
            dest: /vagrant/k8s/temp/dashboard.txt
